# Домашнее задание к занятию «Введение в Terraform»

### Цели задания

1. Установить и настроить Terrafrom.
2. Научиться использовать готовый код.

------

### Чек-лист готовности к домашнему заданию

<img width="1036" height="334" alt="image" src="https://github.com/user-attachments/assets/930d4ea7-7521-41cb-881f-43ae37ae09f1" />

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. Репозиторий с ссылкой на зеркало для установки и настройки Terraform: [ссылка](https://github.com/netology-code/devops-materials).
2. Установка docker: [ссылка](https://docs.docker.com/engine/install/ubuntu/). 
------

### Задание 1

1. Терраформ инициализирован, зависимости скачаны

<img width="1928" height="1169" alt="image" src="https://github.com/user-attachments/assets/a615d906-a466-4333-a1a5-e83a4acf80c4" />

2. Личную секретную информациюдопустимо хранить в `personal.auto.tfvars`, т.к. он игнорируется и не попадает в репозиторий. И более того, он даже подписан комментарием `# own secret vars store.`

3. Безуспешные попытки получить пароль средствами Терраформа:
<img width="1931" height="581" alt="image" src="https://github.com/user-attachments/assets/7862e499-88a3-4651-ad28-588cd148b73d" />

При этом пароь в явном виде есть в файле `terraform.tfstate`

<img width="1931" height="923" alt="image" src="https://github.com/user-attachments/assets/b521ac5d-5018-4f90-b190-c35484478c50" />

Пароль: AgA2Q1IDjYamAdzh

4. Ошибка 1: Missing name for resource

<img width="1359" height="211" alt="image" src="https://github.com/user-attachments/assets/523ca376-478f-42d2-b889-3628f5389285" />

Суть ошибки - в Terraform каждый ресурс должен иметь два лейбла (type, name), а в файле только "docker_image". 

Ошибка 2: Invalid resource name

<img width="1383" height="205" alt="image" src="https://github.com/user-attachments/assets/9be5d64c-2c4a-4456-88c5-27ffb3a5f999" />

Суть ошибки: Имя ресурса не может начинаться с цифры (1nginx). Имя должно начинаться с буквы или подчёркивания. Разрешены только буквы, цифры, подчёркивание и дефис.

Ошибка 3: Reference to undeclared resource

<img width="1383" height="207" alt="image" src="https://github.com/user-attachments/assets/26ee3459-2fc8-4b27-94ba-0d682037c51f" />

Суть ошибки: задано имя ресурса `random_password.random_string_FAKE`, которого нет в конфигурации (нужно убрать `_FAKE`), нужно исправить последнюю букву в слове `resulT` на строчную.
Исправление:
```
terraform {
  required_providers {
    docker = {
      source  = "kreuzwerker/docker"
      version = "~> 3.0.1"
    }
  }
  required_version = ">=1.8.4" /*Многострочный комментарий.
 Требуемая версия terraform */
}
provider "docker" {}

#однострочный комментарий

resource "random_password" "random_string" {
  length      = 16
  special     = false
  min_upper   = 1
  min_lower   = 1
  min_numeric = 1
}


resource "docker_image" "nginx" {
  name         = "nginx:latest"
  keep_locally = true
}


resource "docker_container" "nginx1" {
  image = docker_image.nginx.image_id
  name  = "example_${random_password.random_string.result}"

  ports {
    internal = 80
    external = 9090
  }
}
```

5. Исправленный main.tf выше.
Вывод команды `docker ps`:

<img width="1707" height="89" alt="image" src="https://github.com/user-attachments/assets/124878e3-68a2-49a0-a694-fbccfc92b034" />


6. Опасность применения ключа  `-auto-approve` в том, что он позволяет применить все изменения без подтверждения. Т.е. есть явный риск случайно удалить или изменить важные ресурсы без предварительной проверки.
Польза - для автоматизации, когда код заведомо работает и подтверждения не требуется, либо для тестовой среды, где нет риска удалить что-то важное.

Новый вывод команды ```docker ps```.

<img width="1617" height="87" alt="image" src="https://github.com/user-attachments/assets/c3b4792b-6d84-4459-9860-8adb8bfd4a96" />


7. Ресурсы уничтожены:

<img width="1922" height="424" alt="image" src="https://github.com/user-attachments/assets/79b599db-77f5-4823-ab1a-a3734d9177e3" />

Содержимое файла **terraform.tfstate**:

<img width="1538" height="276" alt="image" src="https://github.com/user-attachments/assets/c6583369-28b3-4501-83b0-7aa9b5a2c64c" />

8. При уничтожении ресурсов с помощью команды `terraform destroy` Docker-образ `nginx:latest` не был удалён и остался на сервере, потому что в коде нет указания его удалить. В Terraform-провайдере Docker для ресурса docker_image это управляется параметром `keep_locally`. Если `keep_locally = false`, образ будет удалён; если keep_locally = true или параметр не задан, образ останется на сервере.


------

## Дополнительное задание (со звёздочкой*)

### Задание 2*

(Не нашёл в доке kreuzwerker/docker способа поднять контейнер именно на 127.0.0.1)

`main.tf` получился такой:
https://github.com/wiqt8r/terraform-homeworks/blob/main/01/src/main.tf

Наличие секретных env-переменных в контейнере:

<img width="1807" height="609" alt="image" src="https://github.com/user-attachments/assets/618d825a-a815-4e0d-8d67-3605d2809c7f" />


### Задание 3*
1. Установите [opentofu](https://opentofu.org/)(fork terraform с лицензией Mozilla Public License, version 2.0) любой версии
2. Попробуйте выполнить тот же код с помощью ```tofu apply```, а не terraform apply.
------

### Правила приёма работы

Домашняя работа оформляется в отдельном GitHub-репозитории в файле README.md.   
Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 

