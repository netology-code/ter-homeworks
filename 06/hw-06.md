# Домашнее задание к занятию «Введение в Terramate»

### Цели задания

1. Познакомиться с инструментом Terramate для управления множественными Terraform стеками.
2. Научиться использовать генерацию кода и глобальные переменные.
3. Освоить работу с несколькими окружениями через единую кодовую базу.

------

### Чек-лист готовности к домашнему заданию

1. Установлен **Terraform** версии >=1.12.0
2. Установлен **Terramate** версии >=0.14.0
3. Скачан код демонстрации из директории [**06/demo**](https://github.com/netology-code/ter-homeworks/tree/main/06/demo)

------

### Инструменты и дополнительные материалы

1. [Официальная документация Terramate](https://terramate.io/docs/)
2. [GitHub репозиторий Terramate](https://github.com/terramate-io/terramate)
3. [Примеры использования Terramate](https://github.com/terramate-io/terramate/tree/main/examples)

------
### Внимание!! Обязательно предоставляем на проверку получившийся код в виде ссылки на ваш github-репозиторий!
------

### Задание 1

1. Установите Terramate на свою рабочую машину:
   - Linux/MacOS: `curl -sfL https://github.com/terramate-io/terramate/releases/latest/download/terramate_$(uname -s)_$(uname -m).tar.gz | tar -xz -C /usr/local/bin terramate`
   - Windows: скачайте бинарник с [GitHub Releases](https://github.com/terramate-io/terramate/releases)
2. Проверьте установку командой `terramate version`
3. Изучите структуру демо-проекта в директории [**06/demo**](https://github.com/netology-code/ter-homeworks/tree/main/06/demo)
4. Выполните команду `terramate generate` в корне проекта
5. Ответьте на вопросы:
   - Какие файлы были сгенерированы?
   - В каких директориях они появились?
   - Что находится в файлах `_backend.tf` и `_providers.tf`?
6. Приложите скриншот вывода команды `terramate list --tags`

------

### Задание 2

1. Перейдите в один из стеков: `cd demo/stacks/example/dev/app`
2. Выполните `terraform init`
3. Выполните `terraform plan`
4. Обратите внимание на outputs в плане
5. Вернитесь в корень проекта: `cd ../../../../../`
6. Выполните команду `terramate run --tags dev terraform plan`
7. Ответьте на вопросы:
   - В чем разница между запуском `terraform plan` в директории стека и `terramate run terraform plan`?
   - Как Terramate определяет, в каких стеках запускать команды?
   - Что произойдет, если выполнить `terramate run --tags prod terraform plan`?
8. Приложите скриншот вывода команды `terramate run --tags dev terraform plan`

------

### Задание 3

1. Создайте новое окружение **staging** между dev и prod:
   - Создайте директорию `stacks/example/staging/app/`
   - Создайте файл `config.tm.hcl` с переопределением переменной `environment = "staging"`
   - Создайте файл `stack.tm.hcl` с описанием стека (name, description, tags, id)
   - Создайте файл `main.tf` с простым ресурсом (можете скопировать из dev и изменить)
2. Выполните `terramate generate` для генерации файлов нового стека
3. Проверьте список стеков командой `terramate list`
4. Выполните инициализацию: `terramate run --tags staging terraform init`
5. Приложите:
   - Содержимое созданных файлов `config.tm.hcl`, `stack.tm.hcl` и `main.tf`
   - Скриншот вывода `terramate list`
   - Скриншот успешной инициализации staging окружения

------

### Задание 4

1. Модифицируйте глобальные переменные в корневом `config.tm.hcl`:
   - Добавьте новую глобальную переменную `owner = "ваше_имя"`
   - Добавьте переменную `tags` со списком общих тегов
2. Обновите `imports/providers.tm.hcl`:
   - Добавьте генерацию locals с общими тегами
3. Используйте эти переменные в одном из `main.tf` файлов стеков
4. Выполните `terramate generate`
5. Проверьте, что изменения применились во всех стеках
6. Приложите:
   - Измененный `config.tm.hcl`
   - Измененный `imports/providers.tm.hcl`
   - Содержимое сгенерированного `_providers.tf` в одном из стеков
   - Вывод команды `terramate debug show globals` из одного из стеков

------

### Задание 5

1. Изучите механизм условной генерации в `imports/backend.tm.hcl`:
   ```hcl
   condition = global.environment != "null"
   ```
2. Ответьте на вопросы:
   - Почему используется это условие?
   - Что будет, если убрать это условие?
   - Где определяется значение `global.environment = "null"` по умолчанию?
3. Создайте новый файл генерации `imports/outputs.tm.hcl`, который будет создавать файл `_outputs.tf` с общими outputs для всех стеков:
   ```hcl
   output "stack_name" {
     value = terramate.stack.name
   }
   output "stack_path" {
     value = terramate.stack.path.relative
   }
   ```
4. Выполните генерацию и проверьте созданные файлы
5. Приложите:
   - Ответы на вопросы
   - Содержимое `imports/outputs.tm.hcl`
   - Содержимое одного из сгенерированных `_outputs.tf`

------

### Задание 6

1. Используя команды Terramate, примените изменения для dev окружения:
   ```bash
   terramate run --tags dev terraform apply
   ```
2. Просмотрите outputs:
   ```bash
   terramate run --tags dev terraform output
   ```
3. Сравните, как отличаются outputs между dev и prod окружениями
4. Удалите созданные ресурсы:
   ```bash
   terramate run --tags dev terraform destroy
   ```
5. Приложите:
   - Скриншот успешного apply
   - Вывод команды `terraform output` для dev
   - Вывод команды `terraform output` для prod (если применяли)
   - Скриншот успешного destroy

------

## Дополнительные задания (со звёздочкой*)

**Настоятельно рекомендуем выполнять все задания со звёздочкой.** Они помогут глубже разобраться в материале.   
Задания со звёздочкой дополнительные, не обязательные к выполнению и никак не повлияют на получение вами зачёта по этому домашнему заданию.

### Задание 7*

1. Настройте Yandex Cloud backend в `imports/backend.tm.hcl` вместо дефолтного S3
2. Создайте S3 bucket в Yandex Cloud для state файлов
3. Настройте переменные для подключения к Yandex Cloud
4. Выполните миграцию state в облако командой `terraform init -migrate-state` для одного из стеков
5. Проверьте, что state файл появился в S3 bucket
6. Приложите:
   - Содержимое обновленного `imports/backend.tm.hcl`
   - Скриншот S3 bucket с state файлами
   - Вывод команды `terraform state list` из стека

### Задание 8*

1. Изучите механизм обнаружения изменений в Terramate:
   ```bash
   # Список измененных стеков
   terramate list --changed
   ```
2. Внесите изменения в один из `main.tf` файлов
3. Закоммитьте изменения в git
4. Выполните `terramate list --changed` до и после коммита
5. Объясните, как Terramate определяет, какие стеки изменились
6. Приложите:
   - Скриншот вывода `terramate list --changed` до коммита
   - Скриншот вывода после коммита
   - Объяснение механизма обнаружения изменений

### Задание 9*

1. Создайте дополнительный генератор для создания `.terraformrc` файлов в каждом стеке
2. Используйте Yandex Cloud mirror для ускорения загрузки провайдеров:
   ```hcl
   provider_installation {
     network_mirror {
       url = "https://terraform-mirror.yandexcloud.net/"
       include = ["registry.terraform.io/*/*"]
     }
   }
   ```
3. Добавьте условие генерации только для определенных окружений
4. Приложите:
   - Содержимое созданного генератора
   - Пример сгенерированного `.terraformrc`
   - Скриншот ускоренной загрузки провайдеров

### Задание 10*

1. Создайте GitHub Actions workflow или GitLab CI pipeline для автоматизации работы с Terramate:
   - Проверка форматирования (`terraform fmt`)
   - Валидация (`terraform validate`)
   - Генерация Terramate файлов (`terramate generate --check`)
   - План изменений для всех стеков (`terramate run terraform plan`)
2. Настройте запуск только для измененных стеков
3. Приложите:
   - Содержимое workflow/pipeline файла
   - Скриншот успешного выполнения

------

### Правила приёма работы

Домашняя работа оформляется в отдельном GitHub-репозитории в файле README.md или в отдельных markdown файлах для каждого задания.
Выполненное домашнее задание пришлите ссылкой на ваш github-репозиторий.

В репозитории должны быть:
- Все файлы проекта с Terramate
- README.md с ответами на вопросы и ссылками на скриншоты
- Скриншоты в отдельной папке `screenshots/`

### Критерии оценки

Зачёт ставится, если:

* выполнены все обязательные задания (1-6),
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики,
* код работает и может быть воспроизведен.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки,
* код не работает или содержит ошибки.

### Дополнительные материалы

1. [Документация Terramate CLI](https://terramate.io/docs/cli/)
2. [Terramate Globals](https://terramate.io/docs/cli/configuration/globals)
3. [Terramate Code Generation](https://terramate.io/docs/cli/code-generation/)
4. [Terramate Orchestration](https://terramate.io/docs/cli/orchestration/)
5. [Примеры на GitHub](https://github.com/terramate-io/terramate/tree/main/examples)

