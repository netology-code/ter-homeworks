# Домашнее задание к занятию «Основы Terraform. Yandex Cloud»

### Цели задания

1. Создать свои ресурсы в облаке Yandex Cloud с помощью Terraform.
2. Освоить работу с переменными Terraform.


### Чек-лист готовности к домашнему заданию

1. Зарегистрирован аккаунт в Yandex Cloud. Использован промокод на грант.
2. Установлен инструмент Yandex CLI.
3. Исходный код для выполнения задания расположен в директории [**02/src**](https://github.com/netology-code/ter-homeworks/tree/main/02/src).



### Задание 0

1. Ознакомьтесь с [документацией к security-groups в Yandex Cloud](https://cloud.yandex.ru/docs/vpc/concepts/security-groups?from=int-console-help-center-or-nav). 
Этот функционал понадобится к следующей лекции.

------
### Внимание!! Обязательно предоставляем на проверку получившийся код в виде ссылки на ваш github-репозиторий!
------

✅ ### Задание 1  (рис.zad_1_01-zad1.09)
В качестве ответа всегда полностью прикладывайте ваш terraform-код в git.
Убедитесь что ваша версия **Terraform** ~>1.12.0

1. Изучите проект. В файле variables.tf объявлены переменные для Yandex provider.
2. Создайте сервисный аккаунт и ключ. [service_account_key_file](https://terraform-provider.yandexcloud.net).
4. Сгенерируйте новый или используйте свой текущий ssh-ключ. Запишите его открытую(public) часть в переменную **vms_ssh_public_root_key**.


---------------------------------

ssh -l alexlinux 158.160.13.187
sudo apt update && sudo apt install wget -y

wget https://hashicorp-releases.yandexcloud.net/terraform/1.12.0/terraform_1.12.0_linux_amd64.zip

sudo apt update
sudo apt install unzip -y

unzip terraform_1.12.0_linux_amd64.zip

sudo mv terraform /usr/local/bin/


alexlinux@compute-vm-2-2-10-hdd-1762100098720:~$ terraform --version
Terraform v1.12.0
on linux_amd64

curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash

nano ~/.terraformrc

provider_installation {
  network_mirror {
    url = "https://terraform-mirror.yandexcloud.net/"
    include = ["registry.terraform.io/*/*"]
  }
  direct {
    exclude = ["registry.terraform.io/*/*"]
  }
}



ls -la ~/.terraformrc

cat ~/.terraformrc

mkdir ~/terraform-project
cd ~/terraform-project

scp -i "C:/Users/IRU/.ssh/id_ed25519" "C:/distr/Distr_Terr/authorized_key.json" alexlinux@158.160.13.187:/home/alexlinux/

scp "C:\\distr\\Distr_Terr\\authorized_key.json" alexlinux@158.160.13.187:/home/


#Проверка успешности

cd ~
git clone https://github.com/sapr797/ter-homeworks
cd terraform-project



cd ~/terraform-project
terraform init
terraform plan

yc iam create-token

cd ~/terraform-project
nano provider.tf

terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
      version = ">= 0.129.0" # Можно указать подходящую версию
    }
  }
  required_version = "~>1.12.0"
}

provider "yandex" {
  cloud_id  = "b1gsp6vsj607j08m27mr"
  folder_id = "enp09m87v5ivgh24jpdr"
  zone      = "ru-central1-b"

token = "t1.9euelZqQjpKZyZSWiZPOxs-bip2Kze3rnpWajoueypyYxpyWyJLOxpiTjY7l9PdoPlg3-e8HWASq3fT3KG1VN_nvB1gEqs3n9euelZqLjY-WlZDKzsbKlI_GnsjLy-_8xeuelZqLjY-WlZDKzsbKlI_GnsjLyw.p3BDtH185LHTPvijWL-7ekf-UOzHO2-G-5WOAYse5p3wBF_MHikZA37usuxk6eKSzVqzt41Dy4z2L2v_n8vvDg"


}
✅1.5. Инициализируйте проект, выполните код. Исправьте намеренно допущенные синтаксические ошибки. Ищите внимательно, посимвольно. Ответьте, в чём заключается их суть.(zad_1_25)


yc iam create-token
yc init

scp "C:\\distr\\Distr_Terr\\authorized_key.json" alexlinux@IP-адрес-вашей-машины:/home/alexlinux/distr/Distr_Terr/

terraform apply

nano variables.tf 

variable "vpc_name" {
  description = "VPC network & subnet name"
  type        = string
  default     = "develop2"
}

yc vpc network list

cat > terraform.tfvars << 'EOF'
cloud_id  = "b1gtb8567n06h9636b87"
folder_id = "b1gokds3ue11292eobjh"
EOF


✅1.6. Подключитесь к консоли ВМ через ssh и выполните команду ``` curl ifconfig.me```.
Примечание: К OS ubuntu "out of a box, те из коробки" необходимо подключаться под пользователем ubuntu: ```"ssh ubuntu@vm_ip_address"```. Предварительно убедитесь, что ваш ключ добавлен в ssh-агент: ```eval $(ssh-agent) && ssh-add``` Вы познакомитесь с тем как при создании ВМ создать своего пользователя в блоке metadata в следующей лекции.;(zad_1_09)

#main.tf
resource "yandex_vpc_network" "default" {
  name = "default"
}
resource "yandex_vpc_subnet" "default" {
  name           = "default-ru-central1-b"
  zone           = var.default_zone
  network_id     = yandex_vpc_network.default.id
  v4_cidr_blocks = var.default_cidr
}


data "yandex_compute_image" "ubuntu" {
  family = "ubuntu-2004-lts"
}
resource "yandex_compute_instance" "platform" {
  name        = "netology-develop-platform-web"
  platform_id = "standard-v3"
  resources {
    cores         = 2
    memory        = 2
    core_fraction = 20
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }
  scheduling_policy {
    preemptible = true
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.default.id
    nat       = true
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${var.vms_ssh_root_key}"
  }

}



#variables.tf

###cloud vars


variable "cloud_id" {
  type        = string
  description = "https://console.yandex.cloud/cloud/b1gtb8567n06h9636b87"
}

variable "folder_id" {
  type        = string
  description = "https://console.yandex.cloud/folders/b1gokds3ue11292eobjh"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-a"
  description = "https://cloud.yandex.ru/docs/overview/concepts/geo-scope"
}
variable "default_cidr" {
  type        = list(string)
  default     = ["10.129.0.0/24"]
  description = "https://cloud.yandex.ru/docs/vpc/operations/subnet-create"
}

variable "vpc_name" {
  type        = string
  default     = "develop"
  description = "VPC network & subnet name"
}


###ssh vars

variable "vms_ssh_root_key" {
  type        = string
  default     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA+8uvPesD your_email@example.com"
  description = "ssh-keygen -t ed25519"
}
 


nano provider.tf


terraform {
  required_providers {
    yandex = {
      source = "yandex-cloud/yandex"
    }
  }
  required_version = "~>1.12.0"
}

provider "yandex" {
  # token     = var.token
  cloud_id                 = var.cloud_id
  folder_id                = var.folder_id
  zone                     = var.default_zone
  service_account_key_file = file("~/.authorized_key.json")
}


terraform {
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 1.12.0"
    }
  }
}

provider "yandex" {
  cloud_id  = "b1gtb8567n06h9636b87"     # Замените на cloud_id нового облака
  folder_id = "b1gokds3ue11292eobjh" # Замените на folder_id нового облака
  zone      = "ru-central1-b"
}



terraform {
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 0.129.0"
    }
  }
  required_version = "~>1.12.0"
}

provider "yandex" {
  cloud_id  = "b1gtb8567n06h9636b87"
  folder_id = "b1gokds3ue11292eobjh"
  zone      = "ru-central1-b"
}


---------
✅1.2. Создайте файл outputs.tf для удобного просмотра IP-адресов:
ssh ubuntu@89.169.175.171 (zad_1_08)
89.169.175.171

cat > outputs.tf << 'EOF'
output "external_ip" {
  value = yandex_compute_instance.platform.network_interface.0.nat_ip_address
  description = "89.169.175.171"
}

output "internal_ip" {
  value = yandex_compute_instance.platform.network_interface.0.ip_address
  description = "10.129.0.5"
}

output "instance_status" {
  value = yandex_compute_instance.platform.status
  description = "Running"
}
EOF

terraform output
-------------------


✅8. Ответьте, как в процессе обучения могут пригодиться параметры ```preemptible = true``` и ```core_fraction=5``` в параметрах ВМ.

В качестве решения приложите:

- скриншот ЛК Yandex Cloud с созданной ВМ, где видно внешний ip-адрес;
- скриншот консоли, curl должен отобразить тот же внешний ip-адрес;
- ответы на вопросы.

preemptible = true	ВМ является прерываемой и может быть остановлена облаком, если с момента ее запуска прошло 24 часа или возникла нехватка ресурсов для запуска не прерываемых машин .	Идеально для учебных заданий и экспериментов, которые не требуют непрерывной работы 24/7. Позволяет радикально сэкономить бюджет .

core_fraction = 5	Указывает гарантированную долю vCPU (в данном случае 5%), т.е. базовый уровень производительности ядра .	Подходит для задач, не требующих постоянной высокой производительности (например, обучение, тестирование конфигураций, запуск простых приложений). Также помогает экономить средства .

==================================================================




✅### Задание 2 (рис. zad 2.10-zad 2.11)

1. Замените все хардкод-**значения** для ресурсов **yandex_compute_image** и **yandex_compute_instance** на **отдельные** переменные. К названиям переменных ВМ добавьте в начало префикс **vm_web_** .  Пример: **vm_web_name**.
2. Объявите нужные переменные в файле variables.tf, обязательно указывайте тип переменной. Заполните их **default** прежними значениями из main.tf. 
3. Проверьте terraform plan. Изменений быть не должно. 

ssh -l ubuntu 51.250.20.116
-------------------------------
1. Обновленный variables.tf
hcl
###cloud vars
variable "cloud_id" {
  type        = string
  default     = "b1gtb8567n06h9636b87"
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  default     = "b1gokds3ue11292eobjh"
  description = "Folder ID"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.129.0.0/24"]
  description = "Default CIDR"
}

variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}

###ssh vars
variable "vms_ssh_root_key" {
  type        = string
  default     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA+8uvPesD your_email@example.com"
  description = "SSH key for VMs"
}

заменяем на 


### VM web variables with vm_web_ prefix
variable "cloud_id" {
  type        = string
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  description = "Folder ID"
}

variable "vm_web_image_family" {
  type        = string
  default     = "ubuntu-2004-lts"
  description = "Image family for web VM"
}

variable "vm_web_name" {
  type        = string
  default     = "netology-develop-platform-web"
  description = "Name for web VM"
}

variable "vm_web_platform_id" {
  type        = string
  default     = "standard-v3"
  description = "Platform ID for web VM"
}

variable "vm_web_cores" {
  type        = number
  default     = 2
  description = "CPU cores for web VM"
}

variable "vm_web_memory" {
  type        = number
  default     = 2
  description = "Memory in GB for web VM"
}

variable "vm_web_core_fraction" {
  type        = number
  default     = 20
  description = "Core fraction for web VM"
}

variable "vm_web_preemptible" {
  type        = bool
  default     = true
  description = "Preemptible flag for web VM"
}

variable "vm_web_nat" {
  type        = bool
  default     = true
  description = "NAT flag for web VM"
}

### Existing variables (должны уже быть у вас)
variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}
variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.129.0.0/24"]
  description = "Default CIDR"
}

variable "vms_ssh_root_key" {
  type        = string
  default     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA+8uvPesD yo>  description = "SSH key for VMs"
}


----------
#main.tf

### VM web variables
variable "vm_web_image_family" {
  type        = string
  default     = "ubuntu-24.04-lts"
  description = "Image family for web VM"
}

variable "vm_web_name" {
  type        = string
  default     = "netology-develop-platform-web"
  description = "Name for web VM"
}

variable "vm_web_platform_id" {
  type        = string
  default     = "standard-v3"
  description = "Platform ID for web VM"
}

variable "vm_web_cores" {
  type        = number
  default     = 2
  description = "CPU cores for web VM"
}

variable "vm_web_memory" {
  type        = number
  default     = 2
  description = "Memory in GB for web VM"
}

variable "vm_web_core_fraction" {
  type        = number
  default     = 20
  description = "Core fraction for web VM"
}

variable "vm_web_disk_size" {
  type        = number
  default     = 20
  description = "Disk size in GB for web VM"
}

variable "vm_web_preemptible" {
  type        = bool
  default     = true
  description = "Preemptible flag for web VM"
}

variable "vm_web_nat" {
  type        = bool
  default     = true
  description = "NAT flag for web VM"
}

--------------------------------------

2. Обновленный main.tf
hcl
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

resource "yandex_vpc_subnet" "develop" {
  name           = var.vpc_name
  zone           = var.default_zone
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

resource "yandex_compute_instance" "platform" {
  name        = var.vm_web_name
  platform_id = var.vm_web_platform_id
  resources {
    cores         = var.vm_web_cores
    memory        = var.vm_web_memory
    core_fraction = var.vm_web_core_fraction
  }
  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
      size     = var.vm_web_disk_size
    }
  }
  scheduling_policy {
    preemptible = var.vm_web_preemptible
  }
  network_interface {
    subnet_id = yandex_vpc_subnet.develop.id
    nat       = var.vm_web_nat
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${var.vms_ssh_root_key}"
  }
}

-------------------------------------------


terraform {
  required_providers {
    yandex = {
      source  = "yandex-cloud/yandex"
      version = ">= 0.129.0"
    }
  }
}

provider "yandex" {
  cloud_id                 = "b1gtb8567n06h9636b87"
  folder_id                = "b1gokds3ue11292eobjh"
  zone                     = "ru-central1-b"
  service_account_key_file = "/home/alexlinux2/authorized_key.json"
}



------------------------------

cat > terraform.tfvars << 'EOF'
cloud_id  = "b1gtb8567n06h9636b87"
folder_id = "b1gokds3ue11292eobjh"
EOF
----------------

✅Ответы на вопросы:
Как в процессе обучения могут пригодиться параметры preemptible = true и core_fraction = 5?

preemptible = true - создает прерываемую ВМ, которая стоит дешевле (до 5 раз), но может быть остановлена облаком. Идеально для учебных сред, где непрерывная работа не критична.

core_fraction = 5 - устанавливает гарантированную долю vCPU в 5%, что значительно снижает стоимость ВМ. Подходит для задач обучения без требований к высокой производительности.

Преимущества для обучения:

Экономия бюджета - можно больше экспериментировать
Безопасность - минимальные затраты даже при забытой ВМ
Достаточно для обучения - хватает для выполнения учебных заданий


✅### Задание 3 (zad 3/12)

1. Создайте в корне проекта файл 'vms_platform.tf' . Перенесите в него все переменные первой ВМ.
2. Скопируйте блок ресурса и создайте с его помощью вторую ВМ в файле main.tf: **"netology-develop-platform-db"** ,  ```cores  = 2, memory = 2, core_fraction = 20```. Объявите её переменные с префиксом **vm_db_** в том же файле ('vms_platform.tf').  ВМ должна работать в зоне "ru-central1-b"
3. Примените изменения.



===================
Использует новые CIDR блоки, которые не конфликтуют с существующими Создаст отдельные подсети для каждой зоны Правильно свяжет ВМ с подсетями в соответствующих зонах


# main.tf

# Локальные переменные
locals {
  ssh_key = var.vms_ssh_root_key
}

# Data source для образа
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

# Создание сети
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

# Создание подсети для зоны ru-central1-b
resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.0.0/24"]  # Измененный CIDR
}

# Создание подсети для зоны ru-central1-a
resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.1.0/24"]  # Измененный CIDR
}

# Первая ВМ (web) - использует подсеть в зоне ru-central1-a
resource "yandex_compute_instance" "platform" {
  name        = var.vm_web_name
  platform_id = var.vm_web_platform_id
  zone        = var.vm_web_zone

  resources {
    cores         = var.vm_web_cores
    memory        = var.vm_web_memory
    core_fraction = var.vm_web_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = var.vm_web_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = var.vm_web_nat
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${local.ssh_key}"
  }
}

# Вторая ВМ (db) - использует подсеть в зоне ru-central1-b
resource "yandex_compute_instance" "platform_db" {
  name        = var.vm_db_name
  platform_id = var.vm_db_platform_id
  zone        = var.vm_db_zone

  resources {
    cores         = var.vm_db_cores
    memory        = var.vm_db_memory
    core_fraction = var.vm_db_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = var.vm_db_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = var.vm_db_nat
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${local.ssh_key}"
  }
}

==========

# variables.tf

variable "cloud_id" {
  type        = string
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  description = "Folder ID"
}

variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.130.0.0/24"]  # Обновленный CIDR
  description = "Default CIDR"
}

variable "vms_ssh_root_key" {
  type        = string
  default     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA>"
  description = "SSH key for VMs"
}

==============





✅### Задание 4 (zad_4.13-zad4.15)

1. Объявите в файле outputs.tf **один** output , содержащий: instance_name, external_ip, fqdn для каждой из ВМ в удобном лично для вас формате.(без хардкода!!!)
2. Примените изменения.

В качестве решения приложите вывод значений ip-адресов команды ```terraform output```.


----------------

# outputs.tf

output "vm_instances" {
  description = "Информация о созданных виртуальных машинах"
  value = {
    for vm in [yandex_compute_instance.platform, yandex_compute_instance.platform_db] :
    vm.name => {
      instance_name = vm.name
      external_ip   = vm.network_interface.0.nat_ip_address
      fqdn          = vm.fqdn
      # При необходимости можно добавить и другие поля:
      # internal_ip = vm.network_interface.0.ip_address
      # status = vm.status
    }
  }
}

======================

terraform apply -auto-approve

alexlinux2@compute-vm-2-2-10-hdd-1762263056561:~/terraform-project$ terraform output
vm_instances = {
  "netology-develop-platform-db" = {
    "external_ip" = "84.252.142.218"
    "fqdn" = "epdm3q83bo431dqsc5ik.auto.internal"
    "instance_name" = "netology-develop-platform-db"
  }
  "netology-develop-platform-web" = {
    "external_ip" = "89.169.147.151"
    "fqdn" = "fhme1n7cmmbdn07mcph2.auto.internal"
    "instance_name" = "netology-develop-platform-web"
  }
}

===============================


✅### Задание 5 (zad_5.16)

1. В файле locals.tf опишите в **одном** local-блоке имя каждой ВМ, используйте интерполяцию ${..} с НЕСКОЛЬКИМИ переменными по примеру из лекции.
2. Замените переменные внутри ресурса ВМ на созданные вами local-переменные.
3. Примените изменения.


Один local-блок в файле locals.tf
Использована интерполяция ${..} для создания имен ВМ с добавлением зоны
Заменены переменные в ресурсах ВМ на local-переменные
Имена ВМ теперь включают зону: netology-develop-platform-web-ru-central1-a и netology-develop-platform-db-ru-central1-b


# locals.tf

locals {
  # Имена ВМ с использованием интерполяции нескольких переменных
  vm_web_name = "${var.vm_web_name}-${var.vm_web_zone}"
  vm_db_name  = "${var.vm_db_name}-${var.vm_db_zone}"
  
  # Дополнительные local-переменные для удобства
  vm_web_platform_id = var.vm_web_platform_id
  vm_web_zone        = var.vm_web_zone
  vm_web_cores       = var.vm_web_cores
  vm_web_memory      = var.vm_web_memory
  vm_web_core_fraction = var.vm_web_core_fraction
  vm_web_preemptible = var.vm_web_preemptible
  vm_web_nat         = var.vm_web_nat
  
  vm_db_platform_id  = var.vm_db_platform_id
  vm_db_zone         = var.vm_db_zone
  vm_db_cores        = var.vm_db_cores
  vm_db_memory       = var.vm_db_memory
  vm_db_core_fraction = var.vm_db_core_fraction
  vm_db_preemptible  = var.vm_db_preemptible
  vm_db_nat          = var.vm_db_nat
  
  ssh_key = var.vms_ssh_root_key
}


# main.tf

# Data source для образа
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

# Создание сети
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

# Создание подсети для зоны ru-central1-b
resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

# Создание подсети для зоны ru-central1-a
resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.1.0/24"]
}

# Первая ВМ (web) - использует local-переменные
resource "yandex_compute_instance" "platform" {
  name        = local.vm_web_name
  platform_id = local.vm_web_platform_id
  zone        = local.vm_web_zone

  resources {
    cores         = local.vm_web_cores
    memory        = local.vm_web_memory
    core_fraction = local.vm_web_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_web_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = local.vm_web_nat
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${local.ssh_key}"
  }
}

# Вторая ВМ (db) - использует local-переменные
resource "yandex_compute_instance" "platform_db" {
  name        = local.vm_db_name
  platform_id = local.vm_db_platform_id
  zone        = local.vm_db_zone

  resources {
    cores         = local.vm_db_cores
    memory        = local.vm_db_memory
    core_fraction = local.vm_db_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_db_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = local.vm_db_nat
  }

  metadata = {
    serial-port-enable = 1
    ssh-keys           = "ubuntu:${local.ssh_key}"
  }
}




====================================



✅### Задание 6 (zad_6.1_17,zad6.3_18,zad_6.5_19)

1. Вместо использования трёх переменных  ".._cores",".._memory",".._core_fraction" в блоке  resources {...}, объедините их в единую map-переменную **vms_resources** и  внутри неё конфиги обеих ВМ в виде вложенного map(object).  
   ```
   пример из terraform.tfvars:
   vms_resources = {
     web={
       cores=2
       memory=2
       core_fraction=5
       hdd_size=10
       hdd_type="network-hdd"
       ...
     },
     db= {
       cores=2
       memory=4
       core_fraction=20
       hdd_size=10
       hdd_type="network-ssd"
       ...
     }
   }
   ```




3. Создайте и используйте отдельную map(object) переменную для блока metadata, она должна быть общая для всех ваших ВМ.
   ```
   пример из terraform.tfvars:
   metadata = {
     serial-port-enable = 1
     ssh-keys           = "ubuntu:ssh-ed25519 AAAAC..."
   }
   ```  
  
5. Найдите и закоментируйте все, более не используемые переменные проекта.
6. Проверьте terraform plan. Изменений быть не должно.

------



6.1




создадим новую map-переменную и заменим отдельные переменные.

1. Обновим vms_platform.tf - добавим новую переменную и удалим старые:

hcl
# vms_platform.tf

# Удалите эти переменные:
# variable "vm_web_cores"
# variable "vm_web_memory" 
# variable "vm_web_core_fraction"
# variable "vm_db_cores"
# variable "vm_db_memory"
# variable "vm_db_core_fraction"

# Добавьте новую map-переменную:
variable "vms_resources" {
  type = map(object({
    cores         = number
    memory        = number
    core_fraction = number
  }))
  description = "Ресурсы для виртуальных машин"
}
2. Создайте файл terraform.tfvars с конфигурацией:

hcl
# terraform.tfvars

vms_resources = {
  web = {
    cores         = 2
    memory        = 1
    core_fraction = 20
  }
  db = {
    cores         = 2
    memory        = 2
    core_fraction = 20
  }
}
3. Обновим locals.tf для использования новой map-переменной:

hcl
# locals.tf

locals {
  # Имена ВМ с использованием интерполяции нескольких переменных
  vm_web_name = "${var.vm_web_name}-${var.vm_web_zone}"
  vm_db_name  = "${var.vm_db_name}-${var.vm_db_zone}"
  
  # Ресурсы из map-переменной
  vm_web_cores         = var.vms_resources.web.cores
  vm_web_memory        = var.vms_resources.web.memory
  vm_web_core_fraction = var.vms_resources.web.core_fraction
  
  vm_db_cores          = var.vms_resources.db.cores
  vm_db_memory         = var.vms_resources.db.memory
  vm_db_core_fraction  = var.vms_resources.db.core_fraction
  
  # Остальные local-переменные
  vm_web_platform_id = var.vm_web_platform_id
  vm_web_zone        = var.vm_web_zone
  vm_web_preemptible = var.vm_web_preemptible
  vm_web_nat         = var.vm_web_nat
  
  vm_db_platform_id  = var.vm_db_platform_id
  vm_db_zone         = var.vm_db_zone
  vm_db_preemptible  = var.vm_db_preemptible
  vm_db_nat          = var.vm_db_nat
  
  ssh_key = var.vms_ssh_root_key
}
4. Файл main.tf остается без изменений, так как он уже использует local-переменные.

Альтернативный, более компактный вариант для locals.tf:

hcl
# locals.tf

locals {
  # Имена ВМ с использованием интерполяции
  vm_web_name = "${var.vm_web_name}-${var.vm_web_zone}"
  vm_db_name  = "${var.vm_db_name}-${var.vm_db_zone}"
  
  # Прямое использование map-переменной без промежуточных local
  vm_web_resources = var.vms_resources.web
  vm_db_resources  = var.vms_resources.db
  
  # Остальные переменные
  vm_web_platform_id = var.vm_web_platform_id
  vm_web_zone        = var.vm_web_zone
  vm_web_preemptible = var.vm_web_preemptible
  vm_web_nat         = var.vm_web_nat
  
  vm_db_platform_id  = var.vm_db_platform_id
  vm_db_zone         = var.vm_db_zone
  vm_db_preemptible  = var.vm_db_preemptible
  vm_db_nat          = var.vm_db_nat
  
  ssh_key = var.vms_ssh_root_key
}
И тогда в main.tf нужно обновить блоки resources:

hcl
# В блоке resources для platform:
resources {
  cores         = local.vm_web_resources.cores
  memory        = local.vm_web_resources.memory
  core_fraction = local.vm_web_resources.core_fraction
}

# В блоке resources для platform_db:
resources {
  cores         = local.vm_db_resources.cores
  memory        = local.vm_db_resources.memory
  core_fraction = local.vm_db_resources.core_fraction

==========================================


Outputs:

vm_instances = {
  "netology-develop-platform-db-ru-central1-b" = {
    "external_ip" = "84.252.142.218"
    "fqdn" = "epdm3q83bo431dqsc5ik.auto.internal"
    "instance_name" = "netology-develop-platform-db-ru-central1-b"
  }
  "netology-develop-platform-web-ru-central1-a" = {
    "external_ip" = "89.169.147.151"
    "fqdn" = "fhme1n7cmmbdn07mcph2.auto.internal"
    "instance_name" = "netology-develop-platform-web-ru-central1-a"
  }
}






====================

✅6.3. Создайте и используйте отдельную map(object) переменную для блока metadata, она должна быть общая для всех ваших ВМ.(zad_6.3_18)
   ```
   пример из terraform.tfvars:
   metadata = {
     serial-port-enable = 1
     ssh-keys           = "ubuntu:ssh-ed25519 AAAAC..."
   }
   ```  


--------------------


создать общую map-переменную для metadata. Вот изменения:

1. Добавьте в vms_platform.tf новую переменную:

hcl
# vms_platform.tf

variable "metadata" {
  type = map(string)
  description = "Общие метаданные для всех ВМ"
  default = {
    serial-port-enable = "1"
    ssh-keys           = "ubuntu:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA"
  }
}
2. Обновите locals.tf - удалите переменную ssh_key и добавьте metadata:

hcl
# locals.tf

l# locals.tf

locals {
  # Имена ВМ с использованием интерполяции
  vm_web_name = "${var.vm_web_name}-${var.vm_web_zone}"
  vm_db_name  = "${var.vm_db_name}-${var.vm_db_zone}"
  
  # Ресурсы из map-переменной - используем ПРЯМОЙ доступ
  vm_web_cores         = var.vms_resources.web.cores
  vm_web_memory        = var.vms_resources.web.memory
  vm_web_core_fraction = var.vms_resources.web.core_fraction
  
  vm_db_cores          = var.vms_resources.db.cores
  vm_db_memory         = var.vms_resources.db.memory
  vm_db_core_fraction  = var.vms_resources.db.core_fraction
  
  # Метаданные общие для всех ВМ
  common_metadata = var.metadata
  
  # Остальные переменные
  vm_web_platform_id = var.vm_web_platform_id
  vm_web_zone        = var.vm_web_zone
  vm_web_preemptible = var.vm_web_preemptible
  vm_web_nat         = var.vm_web_nat
  
  vm_db_platform_id  = var.vm_db_platform_id
  vm_db_zone         = var.vm_db_zone
  vm_db_preemptible  = var.vm_db_preemptible
  vm_db_nat          = var.vm_db_nat
}
3. Обновите main.tf - замените блоки metadata:

# main.tf

# Data source для образа
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

# Создание сети
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

# Создание подсети для зоны ru-central1-b
resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

# Создание подсети для зоны ru-central1-a
resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.1.0/24"]
}

# Первая ВМ (web) - использует local-переменные
resource "yandex_compute_instance" "platform" {
  name        = local.vm_web_name
  platform_id = local.vm_web_platform_id
  zone        = local.vm_web_zone

  resources {
    cores         = local.vm_web_cores
    memory        = local.vm_web_memory
    core_fraction = local.vm_web_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_web_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = local.vm_web_nat
  }

  metadata = local.common_metadata
}

# Вторая ВМ (db) - использует local-переменные
resource "yandex_compute_instance" "platform_db" {
  name        = local.vm_db_name
  platform_id = local.vm_db_platform_id
  zone        = local.vm_db_zone

  resources {
    cores         = local.vm_db_cores
    memory        = local.vm_db_memory
    core_fraction = local.vm_db_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_db_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = local.vm_db_nat
  }

  metadata = local.common_metadata
}

# В ресурсе yandex_compute_instance.platform_db:
metadata = local.common_metadata
4. Удалите переменную vms_ssh_root_key из variables.tf (так как SSH-ключ теперь в общей metadata):

hcl
# variables.tf

variable "cloud_id" {
  type        = string
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  description = "Folder ID"
}

variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.130.0.0/24"]
  description = "Default CIDR"
}


✅5. Обновите terraform.tfvars (если нужно изменить metadata):(zad6.5_19)

hcl
# terraform.tfvars

vms_resources = {
  web = {
    cores         = 2
    memory        = 1
    core_fraction = 20
  }
  db = {
    cores         = 2
    memory        = 2
    core_fraction = 20
  }
}

# При необходимости можно переопределить metadata:
# metadata = {
#   serial-port-enable = "1"
#   ssh-keys           = "ubuntu:ваш-ssh-ключ"
# }
=====================


Outputs:

vm_instances = {
  "netology-develop-platform-db-ru-central1-b" = {
    "external_ip" = "84.252.142.218"
    "fqdn" = "epdm3q83bo431dqsc5ik.auto.internal"
    "instance_name" = "netology-develop-platform-db-ru-central1-b"
  }
  "netology-develop-platform-web-ru-central1-a" = {
    "external_ip" = "89.169.147.151"
    "fqdn" = "fhme1n7cmmbdn07mcph2.auto.internal"
    "instance_name" = "netology-develop-platform-web-ru-central1-a"
  }
}



✅6.5 Найдите и закоментируйте все, более не используемые переменные проекта.

======================

Найдем и закомментируем все неиспользуемые переменные. Сначала проверим, какие переменные используются:

1. Проверим используемые переменные в проекте:

bash
# Проверим, какие переменные реально используются
terraform validate
terraform plan
2. Обновим файлы, закомментировав неиспользуемые переменные:

Файл vms_platform.tf:

hcl
# vms_platform.tf

# Используемые переменные для VM web
variable "vm_web_image_family" {
  type        = string
  default     = "ubuntu-2004-lts"
  description = "Image family for web VM"
}

variable "vm_web_name" {
  type        = string
  default     = "netology-develop-platform-web"
  description = "Название ВМ"
}

variable "vm_web_platform_id" {
  type        = string
  default     = "standard-v1"
  description = "ID платформы"
}

variable "vm_web_zone" {
  type        = string
  default     = "ru-central1-a"
  description = "Зона доступности"
}

variable "vm_web_preemptible" {
  type        = bool
  default     = true
  description = "Preemptible flag for web VM"
}

variable "vm_web_nat" {
  type        = bool
  default     = true
  description = "NAT flag for web VM"
}

# Используемые переменные для VM db
variable "vm_db_name" {
  type        = string
  default     = "netology-develop-platform-db"
  description = "Название ВМ БД"
}

variable "vm_db_platform_id" {
  type        = string
  default     = "standard-v1"
  description = "ID платформы БД"
}

variable "vm_db_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Зона доступности БД"
}

variable "vm_db_preemptible" {
  type        = bool
  default     = true
  description = "Preemptible flag for db VM"
}

variable "vm_db_nat" {
  type        = bool
  default     = true
  description = "NAT flag for db VM"
}

# Новая map-переменная для ресурсов (используется)
variable "vms_resources" {
  type = map(object({
    cores         = number
    memory        = number
    core_fraction = number
  }))
  description = "Ресурсы для виртуальных машин"
}

# Новая map-переменная для metadata (используется)
variable "metadata" {
  type = map(string)
  description = "Общие метаданные для всех ВМ"
  default = {
    serial-port-enable = "1"
    ssh-keys           = "ubuntu:ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA"
  }
}

# ЗАКОММЕНТИРОВАТЬ - больше не используются:
# variable "vm_web_cores" {
#   type        = number
#   default     = 2
#   description = "Количество ядер"
# }
#
# variable "vm_web_memory" {
#   type        = number
#   default     = 1
#   description = "Объем памяти в ГБ"
# }
#
# variable "vm_web_core_fraction" {
#   type        = number
#   default     = 20
#   description = "Процент производительности ядра"
# }
#
# variable "vm_db_cores" {
#   type        = number
#   default     = 2
#   description = "Количество ядер БД"
# }
#
# variable "vm_db_memory" {
#   type        = number
#   default     = 2
#   description = "Объем памяти в ГБ БД"
# }
#
# variable "vm_db_core_fraction" {
#   type        = number
#   default     = 20
#   description = "Процент производительности ядра БД"
# }
Файл variables.tf:

hcl
# variables.tf

# Используемые переменные
variable "cloud_id" {
  type        = string
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  description = "Folder ID"
}

variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.130.0.0/24"]
  description = "Default CIDR"
}

# ЗАКОММЕНТИРОВАТЬ - больше не используется (переехала в metadata):
# variable "vms_ssh_root_key" {
#   type        = string
#   default     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPI/0+QBz+pYYIFnAKTubkGiX4YGy1TvSimA>"
#   description = "SSH key for VMs"
# }




## Дополнительное задание (со звёздочкой*)

**Настоятельно рекомендуем выполнять все задания со звёздочкой.**   
Они помогут глубже разобраться в материале. Задания со звёздочкой дополнительные, не обязательные к выполнению и никак не повлияют на получение вами зачёта по этому домашнему заданию. 


------
✅### Задание 7*(zad7_20)

Изучите содержимое файла console.tf. Откройте terraform console, выполните следующие задания: 

1. Напишите, какой командой можно отобразить **второй** элемент списка test_list.
2. Найдите длину списка test_list с помощью функции length(<имя переменной>).
3. Напишите, какой командой можно отобразить значение ключа admin из map test_map.
4. Напишите interpolation-выражение, результатом которого будет: "John is admin for production server based on OS ubuntu-20-04 with X vcpu, Y ram and Z virtual disks", используйте данные из переменных test_list, test_map, servers и функцию length() для подстановки значений.

**Примечание**: если не догадаетесь как вычленить слово "admin", погуглите: "terraform get keys of map"

В качестве решения предоставьте необходимые команды и их вывод.

------

7.1  Напишите, какой командой можно отобразить **второй** элемент списка test_list.

> element(["first", "second", "third"], 1)

7.2 Найдите длину списка test_list с помощью функции length(<имя переменной>).
>length(["first", "second", "third"])


7.3 Напишите, какой командой можно отобразить значение ключа admin из map test_map.

{admin = "admin_user", user = "regular_user", guest = "guest_user"}["admin"]

7.4  Напишите interpolation-выражение, результатом которого будет: "John is admin for production server based on OS ubuntu-20-04 with X vcpu, Y ram and Z virtual disks", используйте данные из переменных test_list, test_map, servers и функцию length() для подстановки значений.

"John is admin for production server based on OS ubuntu-20-04 with 4 vcpu, 8 ram and 2 virtual disks"
format("%s is %s for production server based on OS %s with %d vcpu, %d ram and %d virtual disks", "John", "admin", "ubuntu-20-04", 4, 8, 2)

✅### Задание 8* (zad8_1_21,zad8_3_22)

1. Напишите и проверьте переменную test и полное описание ее type в соответствии со значением из terraform.tfvars:
```
test = [
  {test
    "dev1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ]
  },
  {
    "dev2" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88",
      "10.0.2.29",
    ]
  },
  {
    "prod1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ]
  },
]
```

-------------------------------

1. Создайте переменную в terraform.tfvars:

hcl
# terraform.tfvars

test = [
  {
    "dev1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ]
  },
  {
    "dev2" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88", 
      "10.0.2.29",
    ]
  },
  {
    "prod1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ]
  },
]
2. Объявите переменную в variables.tf:

# variables.tf

# Существующие переменные
variable "cloud_id" {
  type        = string
  description = "Cloud ID"
}

variable "folder_id" {
  type        = string
  description = "Folder ID"
}

variable "vpc_name" {
  type        = string
  default     = "netology-network"
  description = "VPC network name"
}

variable "default_zone" {
  type        = string
  default     = "ru-central1-b"
  description = "Default zone"
}

variable "default_cidr" {
  type        = list(string)
  default     = ["10.130.0.0/24"]
  description = "Default CIDR"
}

# Новая переменная test
variable "test" {
  type = list(map(list(string)))
  description = "SSH connection strings and IP addresses for servers"
}

3. Проверьте в terraform console:

bash
terraform console

# Посмотреть значение переменной
> var.test

# Посмотреть тип переменной
> type(var.test)

# Посмотреть структуру
> keys(var.test[0])
> values(var.test[0])
Полное описание type для этой переменной:

hcl
type = list(
  object({
    dev1 = list(string)
    dev2 = list(string)
    prod1 = list(string)
  })
)

====================




=========> var.test
tolist([
  tomap({
    "dev1" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ])
  }),
  tomap({
    "dev2" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88",
      "10.0.2.29",
    ])
  }),
  tomap({
    "prod1" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ])
  }),
])
> type(var.test)
list(map(list(string)))
> keys(var.test[0])
tolist([
  "dev1",
])
>

==============================


✅8.2. Напишите выражение в terraform console, которое позволит вычленить строку "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117" из этой переменной.
------

Чтобы извлечь строку "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117" из переменной test, выполните в terraform console:

> var.test[0].dev1[0]
Объяснение:

var.test[0] - первый элемент списка (объект с ключом "dev1")

.dev1 - обращение к ключу "dev1" в объекте

[0] - первый элемент списка внутри "dev1"

Альтернативные способы:

# Через lookup
> lookup(var.test[0], "dev1")[0]

# Через element
> element(var.test[0].dev1, 0)

# Если структура может меняться
> values(var.test[0])[0][0]

Проверbv  другие значения:
# Внутренний IP для dev1
> var.test[0].dev1[1]

# SSH для dev2
> var.test[1].dev2[0]

# SSH для prod1
> var.test[2].prod1[0]
 var.test[0].dev1[0] - это даст нужную строку.

========================

> "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
> var.test[0].dev1[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
> var.test[0]["dev1"][0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
> element(var.test[0].dev1, 0)
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
> var.test
tolist([
  tomap({
    "dev1" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ])
  }),
  tomap({
    "dev2" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88",
      "10.0.2.29",
    ])
  }),
  tomap({
    "prod1" = tolist([
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ])
  }),
])
> lookup(var.test[0], "dev1")[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
> values(var.test[0])[0][0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
>  var.test[0].dev1[1]
"10.0.1.7"
> var.test[1].dev2[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88"
> var.test[2].prod1[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101"
> var.test[0].dev1[0]
"ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117"
>
========

------

✅### Задание 9*(zad9_23,zad9_24)

Используя инструкцию https://cloud.yandex.ru/ru/docs/vpc/operations/create-nat-gateway#tf_1, настройте для ваших ВМ nat_gateway. Для проверки уберите внешний IP адрес (nat=false) у ваших ВМ и проверьте доступ в интернет с ВМ, подключившись к ней через serial console. Для подключения предварительно через ssh измените пароль пользователя: ```sudo passwd ubuntu```



=====================================
# Создание маршрутной таблицы для NAT Gateway

#main.tf

resource "yandex_vpc_route_table" "nat_route_table" {
  name       = "nat-route-table"
  network_id = yandex_vpc_network.develop.id

  static_route {
    destination_prefix = "0.0.0.0/0" # Весь интернет-трафик
    gateway_id         = yandex_vpc_gateway.nat_gateway.id
  }
}

# Создание NAT Gateway
resource "yandex_vpc_gateway" "nat_gateway" {
  name = "nat-gateway"
  shared_egress_gateway {}
}

# Привязка подсетей к маршрутной таблице
resource "yandex_vpc_subnet_route_table_binding" "binding_a" {
  subnet_id     = yandex_vpc_subnet.develop_a.id
  route_table_id = yandex_vpc_route_table.nat_route_table.id
}

resource "yandex_vpc_subnet_route_table_binding" "binding_b" {
  subnet_id     = yandex_vpc_subnet.develop_b.id
  route_table_id = yandex_vpc_route_table.nat_route_table.id
}

# Data source для образа
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

# Создание сети
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

# Создание подсети для зоны ru-central1-b
resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
}

# Создание подсети для зоны ru-central1-a
resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.1.0/24"]
}

# Первая ВМ (web) - использует local-переменные
resource "yandex_compute_instance" "platform" {
  name        = local.vm_web_name
  platform_id = local.vm_web_platform_id
  zone        = local.vm_web_zone

  resources {
    cores         = local.vm_web_cores
    memory        = local.vm_web_memory
    core_fraction = local.vm_web_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_web_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = local.vm_web_nat
  }

  metadata = local.common_metadata
}

# Вторая ВМ (db) - использует local-переменные
resource "yandex_compute_instance" "platform_db" {
  name        = local.vm_db_name
  platform_id = local.vm_db_platform_id
  zone        = local.vm_db_zone

  resources {
    cores         = local.vm_db_cores
    memory        = local.vm_db_memory
    core_fraction = local.vm_db_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_db_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = local.vm_db_nat
  }

  metadata = local.common_metadata
}



----------------

# terraform.tfvars

test = [
  {
    "dev1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@62.84.124.117",
      "10.0.1.7",
    ]
  },
  {
    "dev2" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@84.252.140.88", 
      "10.0.2.29",
    ]
  },
  {
    "prod1" = [
      "ssh -o 'StrictHostKeyChecking=no' ubuntu@51.250.2.101",
      "10.0.1.30",
    ]
  },
]

vms_resources = {
  web = {
    cores         = 2
    memory        = 1
    core_fraction = 20
  }
  db = {
    cores         = 2
    memory        = 2
    core_fraction = 20
  }
}

------------------------

## main.tf

# Data source для образа
data "yandex_compute_image" "ubuntu" {
  family = var.vm_web_image_family
}

# Создание сети
resource "yandex_vpc_network" "develop" {
  name = var.vpc_name
}

# Создание NAT Gateway
resource "yandex_vpc_gateway" "nat_gateway" {
  name = "nat-gateway"
  shared_egress_gateway {}
}

# Создание маршрутной таблицы для NAT Gateway
resource "yandex_vpc_route_table" "nat_route_table" {
  name       = "nat-route-table"
  network_id = yandex_vpc_network.develop.id

  static_route {
    destination_prefix = "0.0.0.0/0"
    gateway_id         = yandex_vpc_gateway.nat_gateway.id
  }
}

# Создание подсети для зоны ru-central1-b
resource "yandex_vpc_subnet" "develop_b" {
  name           = "${var.vpc_name}-b"
  zone           = "ru-central1-b"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = var.default_cidr
  route_table_id = yandex_vpc_route_table.nat_route_table.id
}

# Создание подсети для зоны ru-central1-a
resource "yandex_vpc_subnet" "develop_a" {
  name           = "${var.vpc_name}-a"
  zone           = "ru-central1-a"
  network_id     = yandex_vpc_network.develop.id
  v4_cidr_blocks = ["10.130.1.0/24"]
  route_table_id = yandex_vpc_route_table.nat_route_table.id
}

# Первая ВМ (web) - использует local-переменные
resource "yandex_compute_instance" "platform" {
  name        = local.vm_web_name
  platform_id = local.vm_web_platform_id
  zone        = local.vm_web_zone

  resources {
    cores         = local.vm_web_cores
    memory        = local.vm_web_memory
    core_fraction = local.vm_web_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_web_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_a.id
    nat       = false  # Отключаем внешний IP
  }

  metadata = local.common_metadata
}

# Вторая ВМ (db) - использует local-переменные
resource "yandex_compute_instance" "platform_db" {
  name        = local.vm_db_name
  platform_id = local.vm_db_platform_id
  zone        = local.vm_db_zone

  resources {
    cores         = local.vm_db_cores
    memory        = local.vm_db_memory
    core_fraction = local.vm_db_core_fraction
  }

  boot_disk {
    initialize_params {
      image_id = data.yandex_compute_image.ubuntu.image_id
    }
  }

  scheduling_policy {
    preemptible = local.vm_db_preemptible
  }

  network_interface {
    subnet_id = yandex_vpc_subnet.develop_b.id
    nat       = false  # Отключаем внешний IP
  }

  metadata = local.common_metadata
}
-----------------

# secrets.auto.tfvars
cloud_id  = "b1gtb8567n06h9636b87"
folder_id = "b1gokds3ue11292eobjh"

===========


### Правила приёма работыДля подключения предварительно через ssh измените пароль пользователя: sudo passwd ubuntu
В качестве результата прикрепите ссылку на MD файл с описанием выполненой работы в вашем репозитории. Так же в репозитории должен присутсвовать ваш финальный код проекта.

**Важно. Удалите все созданные ресурсы**.


### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 

